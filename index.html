<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSE Indian Stock Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            padding: 40px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        h1, h2 {
            text-align: center;
            font-size: 2.2rem;
            margin-bottom: 20px;
        }
        select, button, input[type="number"] {
            padding: 12px;
            font-size: 1rem;
            border-radius: 10px;
            border: none;
            margin: 5px 10px 10px 0;
        }
        button {
            background: #10b981;
            color: white;
            cursor: pointer;
        }
        #quoteDisplay {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }
        .watchlist-item {
            margin-top: 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .gain { color: #22c55e; font-weight: bold; }
        .loss { color: #ef4444; font-weight: bold; }
        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“ˆ NSE Indian Stock Monitor</h1>
        <div>
            <label for="stockSelect">Select Stock:</label>
            <select id="stockSelect"></select>
            <input type="number" id="threshold" placeholder="Alert Threshold %" min="0.1" step="0.1">
            <button onclick="addToWatchlist()">Add to Watchlist</button>
        </div>
        <div id="quoteDisplay"></div>
        <h2>ðŸ“‹ Watchlist</h2>
        <div id="watchlist"></div>
    </div>

    <script>
        const API_BASE = 'https://nse-monitor.onrender.com'; // Replace with your deployed backend URL

        let watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');

        async function fetchStockList() {
            try {
                const res = await fetch(`${API_BASE}/stocks`);
                const data = await res.json();
                const select = document.getElementById('stockSelect');

                data.forEach(stock => {
                    const option = document.createElement('option');
                    option.value = stock.symbol;
                    option.textContent = `${stock.symbol} - ${stock.meta.description}`;
                    select.appendChild(option);
                });
            } catch (err) {
                alert("âŒ Failed to fetch stock list: " + err);
            }
        }

        async function fetchQuote(symbol) {
            try {
                const res = await fetch(`${API_BASE}/quote/${symbol}`);
                return await res.json();
            } catch (err) {
                console.error("âŒ Quote error:", err);
                return null;
            }
        }

        function saveWatchlist() {
            localStorage.setItem('watchlist', JSON.stringify(watchlist));
        }

        async function updateWatchlistDisplay() {
            const container = document.getElementById('watchlist');
            container.innerHTML = '';

            for (const stock of watchlist) {
                const data = await fetchQuote(stock.symbol);
                if (!data) continue;

                const current = data.priceInfo.lastPrice;
                const prev = data.priceInfo.previousClose;
                const change = ((current - prev) / prev * 100).toFixed(2);
                const changeClass = change >= stock.threshold ? 'gain' : change <= -stock.threshold ? 'loss' : '';

                const item = document.createElement('div');
                item.className = 'watchlist-item';
                item.innerHTML = `
                    <div>
                        <strong>${stock.symbol}</strong><br>
                        Last Price: â‚¹${current}<br>
                        <span class="${changeClass}">Change: ${change}%</span><br>
                        Threshold: Â±${stock.threshold}%
                    </div>
                    <button class="remove-btn" onclick="removeFromWatchlist('${stock.symbol}')">ðŸ—‘ Remove</button>
                `;

                container.appendChild(item);

                if (Math.abs(change) >= stock.threshold) {
                    showNotification(`${stock.symbol} moved ${change}%!`);
                }
            }
        }

        function addToWatchlist() {
            const symbol = document.getElementById('stockSelect').value;
            const threshold = parseFloat(document.getElementById('threshold').value);

            if (!symbol || isNaN(threshold) || threshold <= 0) {
                alert('Please select a stock and enter a valid threshold.');
                return;
            }

            if (watchlist.some(w => w.symbol === symbol)) {
                alert('Stock already in watchlist.');
                return;
            }

            watchlist.push({ symbol, threshold });
            saveWatchlist();
            updateWatchlistDisplay();
        }

        function removeFromWatchlist(symbol) {
            watchlist = watchlist.filter(s => s.symbol !== symbol);
            saveWatchlist();
            updateWatchlistDisplay();
        }

        function showNotification(message) {
            if (Notification.permission === 'granted') {
                new Notification('ðŸ“¢ Stock Alert', { body: message });
            }
        }

        window.onload = () => {
            fetchStockList();
            updateWatchlistDisplay();

            if ('Notification' in window && Notification.permission !== 'granted') {
                Notification.requestPermission();
            }

            setInterval(updateWatchlistDisplay, 60000); // Refresh every 60 sec
        };
    </script>
</body>
</html>
